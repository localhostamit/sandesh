<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True P2P Chat (No Server)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #f9f9f9; }
        input { padding: 8px; width: 60%; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        #messages { height: 300px; border: 1px solid #ddd; overflow-y: scroll; padding: 10px; background: white; margin-bottom: 10px; }
        .my-msg { text-align: right; color: blue; margin: 5px 0; }
        .peer-msg { text-align: left; color: green; margin: 5px 0; }
        .status { font-weight: bold; color: orange; }
    </style>
</head>
<body>

    <h2>üåê P2P Chat (Works over Internet)</h2>

    <div class="box">
        <p><strong>Step 1:</strong> Your ID is: <span id="my-id" style="font-weight:bold; color:red;">...Generating...</span></p>
        <p><small>Share this ID with your friend so they can call you.</small></p>
    </div>

    <div class="box">
        <label><strong>Step 2:</strong> Friend's ID:</label>
        <input type="text" id="friend-id" placeholder="Paste friend's ID here">
        <button onclick="connectToPeer()">Connect</button>
        <p class="status" id="status">Status: Waiting for connection...</p>
    </div>

    <div id="chat-box" style="display:none;">
        <div id="messages"></div>
        <input type="text" id="msg-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
        <button onclick="sendMessage()">Send</button>
    </div>

<script>
    let peer = new Peer(); // Creates a random ID for you using free PeerJS cloud
    let conn = null;
    let myIdDisplay = document.getElementById('my-id');
    let statusDisplay = document.getElementById('status');
    let chatBox = document.getElementById('chat-box');
    let msgDisplay = document.getElementById('messages');

    // 1. When PeerJS gives us an ID
    peer.on('open', function(id) {
        myIdDisplay.innerText = id;
        statusDisplay.innerText = "Status: Ready! Share your ID.";
    });

    // 2. When someone connects to us
    peer.on('connection', function(connection) {
        setupConnection(connection);
        statusDisplay.innerText = "Status: Connected to " + connection.peer;
        statusDisplay.style.color = "green";
    });

    // 3. Connect to someone else
    function connectToPeer() {
        let friendId = document.getElementById('friend-id').value;
        if (!friendId) return alert("Enter an ID!");
        
        statusDisplay.innerText = "Status: Connecting...";
        let connection = peer.connect(friendId);
        
        connection.on('open', function() {
            setupConnection(connection);
            statusDisplay.innerText = "Status: Connected to " + friendId;
            statusDisplay.style.color = "green";
        });
    }

    // Common setup for both sides
    function setupConnection(connection) {
        conn = connection;
        chatBox.style.display = "block";
        
        // Handle incoming data
        conn.on('data', function(data) {
            addMessage(data, 'peer-msg');
        });
        
        conn.on('close', function() {
            statusDisplay.innerText = "Status: Connection Lost";
            statusDisplay.style.color = "red";
            conn = null;
        });
    }

    // Send Message
    function sendMessage() {
        let input = document.getElementById('msg-input');
        let msg = input.value;
        if (!msg || !conn) return;

        conn.send(msg); // The P2P Magic happens here
        addMessage(msg, 'my-msg');
        input.value = "";
    }

    function addMessage(msg, className) {
        let div = document.createElement('div');
        div.className = className;
        div.innerText = msg;
        msgDisplay.appendChild(div);
        msgDisplay.scrollTop = msgDisplay.scrollHeight; // Auto-scroll
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }
</script>

</body>
</html>